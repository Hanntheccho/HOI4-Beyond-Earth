on_actions = {
	on_capitulation_immediate = {
		effect = {
			ROOT = {
				drop_cosmetic_tag = yes #to balkanize formables...
				every_country = { #this one is for making sure capitulated country allies have a wargoal on the capitulator
					limit = {
						has_war_with = PREV
					}
					every_country = {
						limit = {
							is_in_faction_with = ROOT
							has_war_with = PREV
							NOT = {
								tag = ROOT
							}
						}
						declare_war_on = {
							target = PREV
							type = annex_puppet_wargoal
						}
					}
				} # 
				if = { #if it is a faction leader, dismantle faction, else leave it
					limit = {
						is_faction_leader = yes
					}				
					dismantle_faction = yes
				}
				else = {
					leave_faction = yes
				} # 
				every_subject_country = { #release every subject
					PREV = {
						end_puppet = PREV
					}
				} #
			}
			if = {
				limit = { #this firstly checks if there are other countries involved in this
					ROOT = {
						any_country = {
							has_war_with = PREV #it is at war with the same capitulated country
							NOT = {
								tag = FROM #it is not the capitulator
								is_ally_with = FROM #nor an ally of the capitulator
							}
							any_controlled_state = {
								is_owned_by = PREV.PREV #and also controls at least one state from the capitulated country
							}
						}
					}
				} #
				every_possible_country = { #do not release hidden countries yet, but do remove cores from formable
					limit = {
						exists = no
						is_dynamic_country = no
						#is_a_formable = yes #?
					}
					FROM = {
						every_owned_state = {
							limit = {
								is_core_of = PREV.PREV
							}
							remove_core_of = PREV
						}
					}
					drop_cosmetic_tag = yes #just in case
				}
				every_country = { #give controlers ownership of the controlled states from the capitulated country, end in the on_capitulation
					every_controlled_state = {
						limit = {
							is_owned_by = ROOT
						}
						transfer_state_to = PREV
					}
				} #
				FROM = { #make sure none states are left from above
					annex_country = {
						target = ROOT
					}
				} #
			}
			else = { #if the original if is not true...
				ROOT = {
					if = { #what if the capitulator is a puppet? the OVERLORD gets everything
						limit = {
							FROM = {
								is_puppet = yes
							}
						}
						every_owned_state = {
							limit = {
								is_core_of = FROM.OVERLORD
							}
							transfer_state_to = FROM.OVERLORD
						}
						FROM.OVERLORD = {
							puppet = PREV
							puppet_government_too_PREV = yes
						}
					}
					else = {
						every_owned_state = {
							limit = {
								is_core_of = FROM
							}
							transfer_state_to = FROM
						}
						FROM = {
							puppet = PREV
							puppet_government_too_PREV = yes
						}
					}
					if = {
						limit = {
							is_minor_tag = yes
						}
						every_core_state = {
							remove_core_of = ROOT
						}
					}
				} #
				every_possible_country = { #release hidden countries
					limit = {
						exists = no
						is_dynamic_country = no
						#is_a_formable = yes #?
					}
					FROM = {
						every_owned_state = {
							limit = {
								is_core_of = PREV.PREV
							}
							transfer_state_to = PREV.PREV
							remove_core_of = PREV
						}
					}
					drop_cosmetic_tag = yes #just in case
				}
			}
			ROOT = { #if it is versus an irrelevant country, remove cores when war ends
				if = {
					limit = {
						is_minor_tag = yes
					}
					every_core_state = {
						remove_core_of = PREV
					}
				}
			}
			FROM = { #this is for the notification, winner side
				add_to_array = {
					array = global.winning_country
					value = THIS.id
					index = 0
				}
			}
			ROOT = { #this is for the notification, losser side
				add_to_array = {
					array = global.losing_country
					value = THIS.id
					index = 0
				}
			}
			every_country = { #make the notification pop-up
				limit = {
					is_ai = no
				}
				set_country_flag = country_has_been_defeated
			}			
		}
	}
	on_capitulation = {
		effect = {
			if = { 
				limit = {
					ROOT = { #someone is controlling states other than us? then it must be allied
						NOT = {
							any_country = {
								NOT = {
									OR = {
										tag = FROM
										is_ally_with = FROM
									}	
								}						
								any_controlled_state = {
									is_core_of = PREV.PREV
								}
							}
						}						
					}
					FROM = { # only when we and our allies stop being at war
						has_war = no
						NOT = {
							any_allied_country = {
								has_war = yes
							}
						}
					}
				}
				ROOT = { #debug
					every_owned_state = {
						transfer_state_to = PREV
					}
				}
				every_country = { #all of our allies and us
					limit = {
						OR = {
							tag = FROM
							is_ally_with = FROM
						}						
					}
					every_possible_country = { #release the countries on states where we don't share cores
						limit = {
							exists = no
							is_dynamic_country = no
						}
						every_core_state = {
							limit = {
								is_owned_by = PREV.PREV
								NOT = {
									is_core_of = PREV.PREV
								}
							}
							transfer_state_to = PREV
						}
						drop_cosmetic_tag = yes #just in case
						PREV = { #puppet the released country, if puppet then OVERLORD does
							if = {
								limit = {
									PREV = {
										exists = yes
										is_puppet = no
									}
									is_puppet = yes
								}
								PREV.PREV.OVERLORD = {
									puppet = PREV.PREV
									puppet_government_too_PREV_PREV = yes
								}
							}
							else_if = {
								limit = {
									PREV = {
										exists = yes
										is_puppet = no
									}
								}
								puppet = PREV
								puppet_government_too_PREV = yes
							}
							else = {
								#
							}							
						}					
					}
					every_possible_country = { #make sure the releasable has all its cores not shared with allies
						limit = {
							NOT = {
								tag = PREV
							}
							exists = yes
							any_allied_country = {
								PREV = {
									is_puppet_of = PREV
								}
							}
						}
						every_core_state = {
							limit = {
								is_owned_by = PREV.PREV
								NOT = {
									is_core_of = PREV.PREV
								}
							}
							transfer_state_to = PREV
						}
					}
				}
			}
			else = { #debug
				ROOT = {
					every_owned_state = {
						transfer_state_to = PREV
					}
				}
			}			
		}
	}
###
	on_puppet = { #legacy
		effect = {
			puppet_government_too = yes
		}
	}
	on_release_as_puppet = { #legacy
		effect = {
			puppet_government_too = yes
		}
	}
}
