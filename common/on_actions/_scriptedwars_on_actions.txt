on_actions = {
	on_capitulation_immediate = {
		effect = {
			balkanize_that = yes #balkanize that!
			ROOT = {
				every_country = { #this one is for making sure capitulated country allies have a wargoal on the capitulator and do not peace out
					limit = {
						has_war_with = PREV
					}
					every_country = {
						limit = {
							is_in_faction_with = ROOT
							has_war_with = PREV
							NOT = {
								tag = ROOT
								has_war_with_wargoal_against = {
									target = PREV
								}
							}
						}
						declare_war_on = {
							target = PREV
							type = annex_puppet_wargoal
						}
					}
				} # 
			}
			ROOT = { #for some scenarios where small tags exist, remove cores when war ends
				if = {
					limit = {
						is_minor_tag = yes
					}
					every_core_state = {
						remove_core_of = PREV
					}
				}
			}
			FROM = { #this is for the notification, winner side
				add_to_array = {
					array = global.winning_country
					value = THIS.id
					index = 0
				}
			}
			ROOT = { #this is for the notification, losser side
				add_to_array = {
					array = global.losing_country
					value = THIS.id
					index = 0
				}
			}
			every_country = { #make the notification pop-up
				limit = {
					is_ai = no
				}
				set_country_flag = country_has_been_defeated
			}	
			FROM = {
				annex_country = {
					target = ROOT
				}
			}	
			random_country = {
				limit = {
					if = {
						limit = {
							FROM = {
								is_puppet = yes
							}
						}
						tag = FROM.OVERLORD
					}
					else = {
						tag = FROM
					}
				}
				if = {
					limit = {
						NOT = {
							any_allied_country = {
								has_war = yes
							}
						}
						has_war = no
					}
					every_country = {
						limit = {
							is_ally_with = PREV
						}
						every_occupied_country = {
							limit = {
								if = {
									limit = {
										exists = yes
									}
									is_ally_with = PREV
								}
								else = {
									exists = no
								}
							}
							every_core_state = {
								limit = {
									is_owned_by = PREV.PREV
									NOT = {
										is_core_of = PREV.PREV
									}
								}
								transfer_state_to = PREV
							}
							if = {
								limit = {
									THIS = {
										exists = yes
									}									
								}
								random_country = {
									limit = {
										if = {
											limit = {
												PREV.PREV = {
													is_puppet = yes
												}
											}
											tag = PREV.PREV.OVERLORD
										}
										else = {
											tag = PREV.PREV
										}
									}
									puppet = PREV
									puppet_government_too_PREV_THIS = yes
								}
							}
						}
					}
				}	
			}
		}
	}
	on_capitulation = {
		effect = {
			ROOT = {
				every_owned_state = {
					transfer_state_to = PREV
				}
			}
			FROM = {
				if = {
					limit = {
						is_in_faction = yes
					}
					random_country = {
						limit = {
							is_in_faction_with = PREV
							is_faction_leader = yes
						}
						add_to_faction = ROOT
					}					
				}
			}
		}
	}
}
