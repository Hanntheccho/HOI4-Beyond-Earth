on_actions = {
	on_capitulation_immediate = {
		effect = {
			ROOT = {
				every_country = {
					limit = {
						has_war_with = PREV
					}
					every_country = {
						limit = {
							is_in_faction_with = ROOT
							has_war_with = PREV
							NOT = {
								tag = ROOT
							}
						}
						declare_war_on = {
							target = PREV
							type = annex_puppet_wargoal
						}
					}
				}	
				if = {
					limit = {
						is_faction_leader = yes
					}				
					dismantle_faction = yes
				}
				else = {
					leave_faction = yes
				}
				every_possible_country = {
					limit = {
						exists = no
						any_core_state = {
							is_owned_by = PREV.PREV
						}
					}
					every_core_state = {
						limit = {
							is_core_of = PREV
						}
						remove_core_of = PREV.PREV
					}
				}
			}
			if = {
				limit = {
					ROOT = {
						any_country = {
							has_war_with = PREV
							NOT = {
								tag = FROM
								is_ally_with = FROM
							}
						}
					}
				}
				every_country = {
					every_controlled_state = {
						limit = {
							is_owned_by = ROOT
						}
						transfer_state_to = PREV
					}
				}
				FROM = {
					annex_country = {
						target = ROOT
					}
				}
			}
			else = {

			}
			ROOT = {
				if = {
					limit = {
						is_minor_tag = yes
					}
					every_core_state = {
						remove_core_of = PREV
					}
				}
			}
			FROM = {
				add_to_array = {
					array = global.winning_country
					value = THIS.id
					index = 0
				}
			}
			ROOT = {
				add_to_array = {
					array = global.losing_country
					value = THIS.id
					index = 0
				}
			}
			every_country = {
				limit = {
					is_ai = no
				}
				set_country_flag = country_has_been_defeated
			}
		}
	}
	on_capitulation = {
		effect = {
			if = {
				limit = {
					FROM = {
						has_war = no
						NOT = {
							any_allied_country = {
								has_war = yes
							}
						}
					}
				}
				every_country = {
					limit = {
						OR = {
							tag = FROM
							is_ally_with = FROM
						}						
					}
					every_possible_country = {
						limit = {
							NOT = {
								tag = PREV
							}
							exists = no
							any_core_state = {
								is_owned_by = PREV.PREV
							}
						}
						every_core_state = {
							limit = {
								is_owned_by = PREV.PREV
								NOT = {
									is_core_of = PREV.PREV
								}
							}
							transfer_state_to = PREV
						}
						drop_cosmetic_tag = yes #just in case
						PREV = {
							if = {
								limit = {
									PREV = {
										exists = yes
										is_puppet = no
									}
									is_puppet = yes
								}
								PREV.PREV.OVERLORD = {
									puppet = PREV.PREV
									puppet_government_too_PREV_PREV = yes
								}
							}
							else_if = {
								limit = {
									PREV = {
										exists = yes
										is_puppet = no
									}
								}
								puppet = PREV
								puppet_government_too_PREV = yes
							}
							else = {
								#
							}							
						}					
					}
					every_possible_country = {
						limit = {
							NOT = {
								tag = PREV
							}
							exists = yes
							any_allied_country = {
								PREV = {
									is_puppet_of = PREV
								}
							}
							any_core_state = {
								is_owned_by = PREV.PREV
							}
						}
						every_core_state = {
							limit = {
								is_owned_by = PREV.PREV
								NOT = {
									is_core_of = PREV.PREV
								}
							}
							transfer_state_to = PREV
						}
					}
				}
			}
		}
	}
	###
	on_puppet = {
		effect = {
			puppet_government_too = yes
		}
	}
	on_release_as_puppet = {
		effect = {
			puppet_government_too = yes
		}
	}
}
